<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contractor Work Tracker</title>
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="%234f46e5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M6 16h.01"></path></svg>'>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        :root { 
            font-family: 'Inter', sans-serif; 
            --tw-ring-color: #4f46e5; /* Indigo 600 */
        }
        @supports (font-variation-settings: normal) {
            :root { font-family: 'Inter var', sans-serif; }
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 4px rgba(0, 0, 0, .1) solid;
            border-left-color: #4f46e5; /* Indigo 600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        /* Smaller spinner for buttons */
        .btn-spinner-sm {
            border: 2px rgba(255, 255, 255, .2) solid;
            border-left-color: #fff; /* White for dark buttons */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .btn-spinner-sm.text-indigo-600 {
             border-left-color: #4f46e5; /* Indigo for light buttons */
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom focus ring for accessibility */
        .form-input:focus, .form-select:focus, .form-textarea:focus, .form-button:focus-visible, .pin-input:focus, .form-number-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--tw-ring-color), 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        /* Modal transitions */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        
        /* PIN Input Styles */
        .pin-input {
            width: 3.5rem; /* w-14 */
            height: 4rem; /* h-16 */
            text-align: center;
            font-size: 1.5rem; /* text-2xl */
            border-radius: 0.5rem; /* rounded-lg */
            border-width: 1px;
            border-color: #d1d5db; /* border-gray-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .pin-input.shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Hide number input spinners */
        .pin-input::-webkit-outer-spin-button,
        .pin-input::-webkit-inner-spin-button,
        .form-number-input::-webkit-outer-spin-button,
        .form-number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .pin-input[type=number],
        .form-number-input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* --- Toast Notification Styles --- */
        #toastContainer {
            position: fixed;
            bottom: 1.5rem; /* p-6 */
            right: 1.5rem; /* p-6 */
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* space-x-3 */
            width: 100%;
            max-width: 320px; /* sm:max-w-xs */
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            transition: all 0.3s ease-in-out;
            transform: translateX(100%);
            opacity: 0;
            animation: slideIn 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }
        .toast.toast-warning {
             border-color: #fcd34d; /* amber-300 */
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast-icon {
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            flex-shrink: 0;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(100%); }
        }
        /* Dropdown Styles */
        #userDropdown {
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 50;
            min-width: 10rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 md:p-8">

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Main Application Container -->
    <div class="w-full max-w-7xl mx-auto">
        
        <!-- App Header -->
        <header class="mb-8 flex flex-col sm:flex-row sm:justify-between sm:items-center">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <div class="bg-indigo-600 p-3 rounded-lg">
                    <!-- Simple SVG logo -->
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M6 16h.01"></path></svg>
                </div>
                <h1 id="appTitle" class="text-3xl font-bold text-gray-900">
                    Contractor <span class="text-indigo-600">Work Tracker</span>
                </h1>
            </div>
            
            <!-- Auth Controls -->
            <div id="auth-controls" class="hidden bg-white p-2 rounded-lg shadow-sm border border-gray-200 flex items-center space-x-3">
                <span id="currentUser" class="text-sm text-gray-700 font-medium px-2"></span>
                <!-- Updated button classes to green -->
                <button id="syncDataButton" class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700 transition-colors duration-150 form-button flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-4 h-4 btn-text" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15"></path></svg>
                    <span class="btn-text">Update Database</span>
                    <span class="btn-spinner hidden btn-spinner-sm text-white"></span>
                </button>
                
                <!-- Dropdown Menu for Logout -->
                <div class="relative">
                    <button id="dropdownToggle" type="button" class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 transition-colors duration-150 form-button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                    </button>
                    
                    <div id="userDropdown" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="dropdownToggle">
                        <div class="py-1" role="none">
                            <button id="logoutButton" class="w-full text-left rounded-md px-4 py-2 text-sm text-red-700 hover:bg-red-50 hover:text-red-800 transition-colors duration-150 form-button flex items-center gap-2" role="menuitem">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Log Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loadingView" class="flex flex-col items-center justify-center p-16 bg-white rounded-xl shadow-lg border border-gray-200">
            <div class="spinner"></div>
            <p class="text-gray-600 mt-4 text-lg">Loading data...</p>
        </div>

        <!-- Login View -->
        <div id="loginView" class="hidden p-10 bg-white rounded-xl shadow-lg border border-gray-200 max-w-lg mx-auto">
            <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Contractor Portal Login</h2>
            
            <form id="contractorLoginForm" class="space-y-6">
                <div>
                    <label for="contractorUsername" class="block text-sm font-medium text-gray-700 mb-1">Contractor Username</label>
                    <input type="text" id="contractorUsername" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="form-button w-full rounded-lg bg-gray-700 px-8 py-4 text-lg font-semibold text-white shadow-md hover:bg-gray-800 transition-all duration-200 transform hover:-translate-y-0.5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 flex items-center justify-center gap-2">
                    <span class="btn-text">Login as Contractor</span>
                    <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                </button>
            </form>
            
            <p id="loginError" class="text-red-500 text-sm text-center h-5 mt-4"></p>
            
            <div class="text-center mt-8 border-t border-gray-200 pt-6">
                <button id="adminLoginButton" type="button" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 hover:underline form-button">
                    Log in as Administrator
                </button>
             </div>
        </div>

        <!-- Administrator View -->
        <div id="adminView" class="hidden space-y-8">
            <header class="flex flex-col md:flex-row justify-between md:items-center gap-4 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Admin Dashboard</h2>
                    <p class="text-gray-600 mt-1">Manage all projects and tasks.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="openAddProjectModal" class="rounded-lg bg-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 transition-all duration-200 transform hover:-translate-y-0.5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        Add New Project
                    </button>
                </div>
            </header>

            <!-- Projects List Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">All Projects</h3>
                <div id="adminProjectsList" class="space-y-6">
                    <!-- Projects will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Contractor View -->
        <div id="contractorView" class="hidden space-y-8">
             <header class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-900">Your Assigned Projects</h2>
                <p class="text-gray-600 mt-1">Update task status and quantities below. Press 'Update to Database' in the header to save your changes.</p>
             </header>
             
            <div id="contractorProjectCardsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Contractor's project cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Admin PIN Modal -->
    <div id="adminPinModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Admin Login</h3>
                <button type="button" class="close-modal-btn rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 form-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p class="text-gray-600 text-center mb-4">Please enter the 6-digit admin PIN.</p>
            
            <div id="pinContainer" class="flex justify-center gap-2 mb-4">
                <input type="text" class="pin-input" maxlength="1" data-index="0" inputmode="numeric">
                <input type="text" class="pin-input" maxlength="1" data-index="1" inputmode="numeric">
                <input type="text" class="pin-input" maxlength="1" data-index="2" inputmode="numeric">
                <input type="text" class="pin-input" maxlength="1" data-index="3" inputmode="numeric">
                <input type="text" class="pin-input" maxlength="1" data-index="4" inputmode="numeric">
                <input type="text" class="pin-input" maxlength="1" data-index="5" inputmode="numeric">
            </div>
            
            <p id="pinError" class="text-red-500 text-sm text-center h-5 mb-4"></p>

            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button type="button" class="close-modal-btn rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Add New Project</h3>
                <button type="button" class="close-modal-btn rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 form-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="addProjectForm" class="space-y-5">
                <div>
                    <label for="newProjectName" class="block text-sm font-medium text-gray-700 mb-1">Project Name <span class="text-red-500">*</span></label>
                    <input type="text" id="newProjectName" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="newProjectStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="newProjectStartDate" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="newProjectEndDate" class="block text-sm font-medium text-gray-700 mb-1">Target End Date</label>
                        <input type="date" id="newProjectEndDate" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <div>
                    <label for="newProjectLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="newProjectLocation" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="newProjectContractor" class="block text-sm font-medium text-gray-700 mb-1">Assigned Contractor (Username)</label>
                    <input type="text" id="newProjectContractor" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 'john_doe_construction'">
                </div>
                
                <div>
                    <label for="newProjectDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="newProjectDescription" rows="3" class="form-textarea block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" class="close-modal-btn rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                        Cancel
                    </button>
                    <button type="submit" class="w-full sm:w-auto rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 transition-all duration-200 form-button flex items-center justify-center gap-2">
                        <span class="btn-text">Add Project</span>
                        <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Edit Project</h3>
                <button type="button" class="close-modal-btn rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 form-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="editProjectForm" class="space-y-5">
                <input type="hidden" id="editProjectId">
                <div>
                    <label for="editProjectName" class="block text-sm font-medium text-gray-700 mb-1">Project Name <span class="text-red-500">*</span></label>
                    <input type="text" id="editProjectName" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="editProjectStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="editProjectStartDate" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="editProjectEndDate" class="block text-sm font-medium text-gray-700 mb-1">Target End Date</label>
                        <input type="date" id="editProjectEndDate" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <div>
                    <label for="editProjectLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="editProjectLocation" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="editProjectContractor" class="block text-sm font-medium text-gray-700 mb-1">Assigned Contractor (Username)</label>
                    <input type="text" id="editProjectContractor" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 'john_doe_construction'">
                </div>
                
                <div>
                    <label for="editProjectDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="editProjectDescription" rows="3" class="form-textarea block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" class="close-modal-btn rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                        Cancel
                    </button>
                    <button type="submit" class="w-full sm:w-auto rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 transition-all duration-200 form-button flex items-center justify-center gap-2">
                        <span class="btn-text">Save Changes</span>
                        <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0 overflow-y-auto">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 md:p-8 transform scale-95 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Add New Task</h3>
                <button type="button" class="close-modal-btn rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 form-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="addTaskForm" class="space-y-5">
                <input type="hidden" id="addTaskProjectId">
                
                <div>
                    <label for="newTaskName" class="block text-sm font-medium text-gray-700 mb-1">Task Name <span class="text-red-500">*</span></label>
                    <input type="text" id="newTaskName" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>

                <div>
                    <label for="newTaskGroup" class="block text-sm font-medium text-gray-700 mb-1">Task Group (e.g., "Phase 1", "Plumbing")</label>
                    <input type="text" id="newTaskGroup" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">
                </div>

                <!-- Task Cost -->
                <div>
                    <label for="newTaskCost" class="block text-sm font-medium text-gray-700 mb-1">Task Cost (PHP) <span class="text-red-500">*</span></label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                            <span class="text-gray-500 sm:text-sm">₱</span>
                        </div>
                        <input type="number" id="newTaskCost" class="form-number-input form-input block w-full rounded-lg border-gray-300 py-3 px-4 pl-10 focus:border-indigo-500 focus:ring-indigo-500" placeholder="1.00" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-5 border-t border-gray-200 pt-5">
                    <div>
                        <label for="newTaskTotalQty" class="block text-sm font-medium text-gray-700 mb-1">Total Qty (Optional)</label>
                        <input type="number" id="newTaskTotalQty" class="form-number-input form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 100" min="0">
                        <p class="text-xs text-gray-500 mt-1">If set, progress is qty-based.</p>
                    </div>
                     <div>
                        <label for="newTaskUnit" class="block text-sm font-medium text-gray-700 mb-1">Unit (Optional)</label>
                        <input type="text" id="newTaskUnit" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., sqm, pcs, m">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" class="close-modal-btn rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                        Cancel
                    </button>
                    <button type="submit" class="w-full sm:w-auto rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 transition-all duration-200 form-button flex items-center justify-center gap-2">
                        <span class="btn-text">Add Task</span>
                        <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0 overflow-y-auto">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 md:p-8 transform scale-95 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Edit Task</h3>
                <button type="button" class="close-modal-btn rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 form-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="editTaskForm" class="space-y-5">
                <input type="hidden" id="editTaskId">
                <input type="hidden" id="editTaskProjectId">
                
                <div>
                    <label for="editTaskName" class="block text-sm font-medium text-gray-700 mb-1">Task Name <span class="text-red-500">*</span></label>
                    <input type="text" id="editTaskName" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>

                <div>
                    <label for="editTaskGroup" class="block text-sm font-medium text-gray-700 mb-1">Task Group</label>
                    <input type="text" id="editTaskGroup" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">
                </div>
                
                <!-- Edit Task Cost -->
                <div>
                    <label for="editTaskCost" class="block text-sm font-medium text-gray-700 mb-1">Task Cost (PHP) <span class="text-red-500">*</span></label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                            <span class="text-gray-500 sm:text-sm">₱</span>
                        </div>
                        <input type="number" id="editTaskCost" class="form-number-input form-input block w-full rounded-lg border-gray-300 py-3 px-4 pl-10 focus:border-indigo-500 focus:ring-indigo-500" placeholder="1.00" min="0" step="0.01" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5 border-t border-gray-200 pt-5">
                    <div>
                        <label for="editTaskTotalQty" class="block text-sm font-medium text-gray-700 mb-1">Total Qty</label>
                        <input type="number" id="editTaskTotalQty" class="form-number-input form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 100" min="0">
                        <p class="text-xs text-gray-500 mt-1">If set, progress is qty-based.</p>
                    </div>
                     <div>
                        <label for="editTaskUnit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="editTaskUnit" class="form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., sqm, pcs, m">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-5 border-t border-gray-200 pt-5">
                    <div>
                        <label for="editTaskQtyCompleted" class="block text-sm font-medium text-gray-700 mb-1">Qty Completed</label>
                        <input type="number" id="editTaskQtyCompleted" class="form-number-input form-input block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 50" min="0">
                    </div>
                     <div>
                        <label for="editTaskStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="editTaskStatus" class="form-select block w-full rounded-lg border-gray-300 shadow-sm py-3 px-4 focus:border-indigo-500 focus:ring-indigo-500">
                             <!-- Options will be populated by JavaScript -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ignored if Qty is used.</p>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" class="close-modal-btn rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                        Cancel
                    </button>
                    <button type="submit" class="w-full sm:w-auto rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 transition-all duration-200 form-button flex items-center justify-center gap-2">
                        <span class="btn-text">Save Changes</span>
                        <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NEW: Delete Confirmation Modal (Now used for Logout Confirmation too) -->
    <div id="deleteConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
                    <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mt-5">Delete Item?</h3>
                <p id="deleteConfirmMessage" class="text-gray-600 mt-2 mb-6">Are you sure you want to delete this? This action cannot be undone.</p>
            </div>
            <div class="flex justify-center gap-4 pt-4 border-t border-gray-200">
                <button type="button" class="close-modal-btn w-full rounded-lg bg-gray-100 px-5 py-2.5 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-200 transition-colors duration-150 form-button">
                    Cancel
                </button>
                <button id="confirmDeleteButton" type="button" class="w-full rounded-lg bg-red-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-red-700 transition-colors duration-150 form-button flex items-center justify-center gap-2">
                    <span class="btn-text">Delete</span>
                    <span class="btn-spinner hidden spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                </button>
            </div>
        </div>
    </div>


    <!-- App Logic -->
    <script type="module">
        // --- GLOBAL VARIABLES ---
        
        // !!! IMPORTANT !!!
        // PASTE YOUR SHEETDB API URL HERE
        const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/py2kvajx66f1s';

        const DATA_SHEET = 'data';
        
        const LOCAL_STORAGE_DATA_KEY = 'contractorApp_data_v2';
        const LOCAL_STORAGE_USER_KEY = 'contractorApp_user';

        let currentRole = null;
        let hasUnsyncedChanges = false; 

        let allProjectsCache = [];

        const TASK_STATUSES = ["Not Started", "In Progress", "Completed"];
        const ADMIN_PIN = "130400"; 
        
        // NEW: Currency Formatter
        const phpFormatter = new Intl.NumberFormat('en-PH', {
            style: 'currency',
            currency: 'PHP',
        });
        
        function formatAsPHP(amount) {
            return phpFormatter.format(amount || 0);
        }

        // NEW: Time Utility
        const timeSince = (dateString) => {
            if (!dateString) return 'Never';
            const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            
            return Math.floor(seconds) > 10 ? Math.floor(seconds) + " seconds ago" : "Just now";
        };

        // --- DOM Elements ---
        const loadingView = document.getElementById('loadingView');
        const loginView = document.getElementById('loginView');
        const adminView = document.getElementById('adminView');
        const contractorView = document.getElementById('contractorView');
        
        const appTitle = document.getElementById('appTitle');
        const authControls = document.getElementById('auth-controls');
        const currentUserEl = document.getElementById('currentUser');
        const logoutButton = document.getElementById('logoutButton');
        const syncDataButton = document.getElementById('syncDataButton');
        
        // NEW Dropdown elements
        const dropdownToggle = document.getElementById('dropdownToggle');
        const userDropdown = document.getElementById('userDropdown');
        
        const contractorLoginForm = document.getElementById('contractorLoginForm');
        const contractorUsernameInput = document.getElementById('contractorUsername');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const loginError = document.getElementById('loginError');
        
        const adminProjectsList = document.getElementById('adminProjectsList');
        const contractorProjectCardsList = document.getElementById('contractorProjectCardsList');
        
        // Modals
        const addProjectModal = document.getElementById('addProjectModal');
        const addTaskModal = document.getElementById('addTaskModal');
        const adminPinModal = document.getElementById('adminPinModal');
        const editProjectModal = document.getElementById('editProjectModal'); 
        const editTaskModal = document.getElementById('editTaskModal');
        // NEW: Delete Modal (now used for confirmation)
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        
        const openAddProjectModalBtn = document.getElementById('openAddProjectModal');

        // Note: Global Expand/Collapse buttons removed based on user request.
        
        // Add Project Form
        const addProjectForm = document.getElementById('addProjectForm');
        const newProjectNameInput = document.getElementById('newProjectName');
        const newProjectStartDateInput = document.getElementById('newProjectStartDate');
        const newProjectEndDateInput = document.getElementById('newProjectEndDate');
        const newProjectLocationInput = document.getElementById('newProjectLocation');
        const newProjectContractorInput = document.getElementById('newProjectContractor');
        const newProjectDescriptionInput = document.getElementById('newProjectDescription');
        
        // Edit Project Form
        const editProjectForm = document.getElementById('editProjectForm');
        const editProjectIdInput = document.getElementById('editProjectId');
        const editProjectNameInput = document.getElementById('editProjectName');
        const editProjectStartDateInput = document.getElementById('editProjectStartDate');
        const editProjectEndDateInput = document.getElementById('editProjectEndDate');
        const editProjectLocationInput = document.getElementById('editProjectLocation');
        const editProjectContractorInput = document.getElementById('editProjectContractor');
        const editProjectDescriptionInput = document.getElementById('editProjectDescription');
        
        // Add Task Form
        const addTaskForm = document.getElementById('addTaskForm');
        const addTaskProjectIdInput = document.getElementById('addTaskProjectId');
        const newTaskNameInput = document.getElementById('newTaskName');
        const newTaskGroupInput = document.getElementById('newTaskGroup');
        const newTaskCostInput = document.getElementById('newTaskCost'); // NEW
        const newTaskTotalQtyInput = document.getElementById('newTaskTotalQty');
        const newTaskUnitInput = document.getElementById('newTaskUnit');
        
        // Edit Task Form
        const editTaskForm = document.getElementById('editTaskForm');
        const editTaskIdInput = document.getElementById('editTaskId');
        const editTaskProjectIdInput = document.getElementById('editTaskProjectId');
        const editTaskNameInput = document.getElementById('editTaskName');
        const editTaskGroupInput = document.getElementById('editTaskGroup');
        const editTaskCostInput = document.getElementById('editTaskCost'); // NEW
        const editTaskTotalQtyInput = document.getElementById('editTaskTotalQty');
        const editTaskUnitInput = document.getElementById('editTaskUnit');
        const editTaskQtyCompletedInput = document.getElementById('editTaskQtyCompleted');
        const editTaskStatusInput = document.getElementById('editTaskStatus');

        // PIN Modal Elements
        const pinContainer = document.getElementById('pinContainer');
        const pinInputs = pinContainer.querySelectorAll('.pin-input');
        const pinError = document.getElementById('pinError');
        
        // Toast Container
        const toastContainer = document.getElementById('toastContainer');

        // --- LOCAL STORAGE & DATA CACHE ---
        
        function saveDataToLocal() {
            try {
                // Store only the current user's projects for the contractor, but all projects for the admin
                const user = JSON.parse(localStorage.getItem(LOCAL_STORAGE_USER_KEY));
                const dataToStore = currentRole === 'contractor' && user?.username
                    ? allProjectsCache.filter(p => p.assignedContractor === user.username) 
                    : allProjectsCache;
                
                localStorage.setItem(LOCAL_STORAGE_DATA_KEY, JSON.stringify(dataToStore));
            } catch (error) {
                console.error("Error saving to local storage:", error);
                showToast("Error saving data locally.", true);
            }
        }

        function loadDataFromLocal() {
            try {
                const dataStr = localStorage.getItem(LOCAL_STORAGE_DATA_KEY);
                if (dataStr) {
                    allProjectsCache = JSON.parse(dataStr) || [];
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Error loading from local storage:", error);
                localStorage.removeItem(LOCAL_STORAGE_DATA_KEY);
                return false;
            }
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewId) {
            loadingView.classList.add('hidden');
            loginView.classList.add('hidden');
            adminView.classList.add('hidden');
            contractorView.classList.add('hidden');
            authControls.classList.add('hidden');

            if (viewId === 'login') {
                loginView.classList.remove('hidden');
            } else if (viewId === 'admin') {
                adminView.classList.remove('hidden');
                authControls.classList.remove('hidden');
            } else if (viewId === 'contractor') {
                contractorView.classList.remove('hidden');
                authControls.classList.remove('hidden');
            } else {
                loadingView.classList.remove('hidden');
            }
        }
        
        // NEW: Setter function to guarantee sync button update
        function setUnsyncedChanges(status) {
            if (hasUnsyncedChanges !== status) {
                hasUnsyncedChanges = status;
                updateSyncButtonState();
            }
        }

        // Function to toggle button state and text
        function updateSyncButtonState() {
            syncDataButton.disabled = !hasUnsyncedChanges;

            if (currentRole === 'admin') {
                syncDataButton.querySelector('.btn-text').textContent = 'Update Database';
            } else if (currentRole === 'contractor') {
                syncDataButton.querySelector('.btn-text').textContent = 'Update to Database';
            }
            // The disabled:opacity-50 class in the HTML handles the fading effect based on the `disabled` attribute.
        }


        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let iconHtml;
            if (type === 'error') {
                toast.classList.add('border-red-300');
                iconHtml = `
                    <svg class="toast-icon text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>`;
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
                iconHtml = `
                    <svg class="toast-icon text-amber-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.33-.266 2.98-1.742 2.98H4.42c-1.476 0-2.492-1.65-1.742-2.98l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>`;
            } else { // success
                toast.classList.add('border-green-300');
                iconHtml = `
                    <svg class="toast-icon text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>`;
            }
            
            toast.innerHTML = `
                ${iconHtml}
                <p class="text-sm font-medium text-gray-800">${escapeHTML(message)}</p>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        // --- MODAL MANAGEMENT ---
        function openModal(modal) {
            if (!modal) return;
            modal.classList.remove('invisible', 'opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            
            if (modal === adminPinModal) {
                resetPinModal();
                pinInputs[0].focus();
            }
        }

        function closeModal(modal) {
            if (!modal) return;
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('invisible');
                resetForms();
                if (modal === adminPinModal) {
                    resetPinModal();
                }
            }, 300);
            
            // Ensure delete button resets to delete state after any closure
            confirmDeleteButton.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmDeleteButton.classList.remove('bg-amber-600', 'hover:bg-amber-700');
            confirmDeleteButton.querySelector('.btn-text').textContent = 'Delete';
            confirmDeleteButton.dataset.itemType = 'project'; // Default to a safe type
        }

        function resetForms() {
            addProjectForm.reset();
            addTaskForm.reset();
            editProjectForm.reset(); 
            editTaskForm.reset(); 
            
            document.querySelectorAll('.form-button').forEach(btn => {
                btn.disabled = false;
                btn.querySelector('.btn-text')?.classList.remove('hidden');
                btn.querySelector('.btn-spinner')?.classList.add('hidden');
            });
        }
        
        function showFormLoading(form, isLoading) {
            const button = form.querySelector('button[type="submit"]');
            if (!button) return;
            
            button.disabled = isLoading;
            button.querySelector('.btn-text')?.classList.toggle('hidden', isLoading);
            button.querySelector('.btn-spinner')?.classList.toggle('hidden', !isLoading);
        }
        
        // --- PIN MODAL LOGIC ---
        function resetPinModal() {
            pinError.textContent = '';
            pinInputs.forEach(input => {
                input.value = '';
                input.classList.remove('shake', 'border-red-500', 'focus:ring-red-500');
                input.classList.add('border-gray-300', 'focus:ring-indigo-500');
            });
        }
        
        function handlePinInput(e) {
            const input = e.target;
            const index = parseInt(input.dataset.index);
            
            if (!/^\d*$/.test(input.value)) {
                input.value = input.value.replace(/\D/g, '');
            }
            input.value = input.value.slice(0, 1);

            if (input.value && index < pinInputs.length - 1) {
                pinInputs[index + 1].focus();
            }

            if (index === pinInputs.length - 1 && input.value) {
                checkPin();
            }
        }

        function handlePinBackspace(e) {
            if (e.key === 'Backspace') {
                const input = e.target;
                const index = parseInt(input.dataset.index);
                if (index > 0 && !input.value) {
                    pinInputs[index - 1].focus();
                }
            }
        }
        
        function handlePinPaste(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '');
            
            if (digits.length === pinInputs.length) {
                pinInputs.forEach((input, index) => {
                    input.value = digits[index];
                });
                checkPin();
            }
        }

        async function checkPin() {
            let pin = '';
            pinInputs.forEach(input => {
                pin += input.value;
            });

            if (pin.length === pinInputs.length) {
                if (pin === ADMIN_PIN) {
                    pinError.textContent = '';
                    closeModal(adminPinModal);
                    
                    showView('loading'); 
                    try {
                        const projects = await loadAdminDataFromSheetDB();
                        allProjectsCache = projects;
                        
                        saveDataToLocal();
                        localStorage.setItem(LOCAL_STORAGE_USER_KEY, JSON.stringify({ role: 'admin' }));
                        currentRole = 'admin';

                        currentUserEl.textContent = 'Logged in as Admin';
                        updateSyncButtonState(); // Update button state
                        renderAdminProjects();
                        showView('admin');
                    } catch (error) {
                        console.error("Admin login failed:", error);
                        showToast(`Login failed: ${error.message}`, 'error');
                        showView('login');
                    }
                } else {
                    pinError.textContent = 'Incorrect PIN. Please try again.';
                    pinInputs.forEach(input => {
                        input.classList.add('shake', 'border-red-500', 'focus:ring-red-500');
                        input.classList.remove('border-gray-300', 'focus:ring-indigo-500');
                    });
                    setTimeout(resetPinModal, 500);
                    pinInputs[0].focus();
                }
            }
        }

        // --- RENDERING FUNCTIONS ---
        
        function renderAdminProjects() {
            adminProjectsList.innerHTML = '';
            
            if (allProjectsCache.length === 0) {
                adminProjectsList.innerHTML = '<p class="text-gray-500 p-4 text-center">No projects found. Add one to get started.</p>';
                adminProjectsList.className = 'space-y-6';
                return;
            }
            
            adminProjectsList.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';

            const sortedProjects = [...allProjectsCache].sort((a, b) => (new Date(b.createdAt) || 0) - (new Date(a.createdAt) || 0));

            sortedProjects.forEach(project => {
                const projectTasks = project.tasks || [];
                const sortedTasks = [...projectTasks].sort((a, b) => (new Date(a.createdAt) || 0) - (new Date(b.createdAt) || 0));
                
                const taskGroups = groupTasks(sortedTasks);
                const projectEl = document.createElement('div');
                projectEl.className = 'border border-gray-200 rounded-lg p-5 shadow-sm bg-white flex flex-col';
                
                // UPDATED: Progress calculation
                const { progress, completedValue, totalProjectCost } = calculateProjectProgress(projectTasks);
                const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString() : 'N/A';
                const endDate = project.targetEndDate ? new Date(project.targetEndDate).toLocaleDateString() : 'N/A';
                
                // NEW: Last Update Time
                const lastSync = project.lastContractorSync ? timeSince(project.lastContractorSync) : 'Never';
                const syncColor = project.lastContractorSync ? 'text-green-600' : 'text-gray-500';


                projectEl.innerHTML = `
                    <div class="mb-4">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-start mb-3 gap-2">
                            <h4 class="text-2xl font-semibold text-gray-800">${escapeHTML(project.name)}</h4>
                            <div class="flex-shrink-0 flex items-center gap-2">
                                <span class="text-sm font-semibold text-indigo-600">${progress.toFixed(0)}% Complete</span>
                                <button type="button" class="open-edit-project-modal-btn rounded-md bg-gray-100 p-1.5 text-gray-600 shadow-sm hover:bg-gray-200" data-project-id="${project.id}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                                </button>
                                <!-- NEW: Delete Project Button -->
                                <button type="button" class="open-delete-modal-btn rounded-md bg-red-100 p-1.5 text-red-700 shadow-sm hover:bg-red-200" data-item-type="project" data-project-id="${project.id}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-4">
                            <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700 border-t border-b border-gray-100 py-3 mb-3">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <strong>Contractor:</strong> ${project.assignedContractor ? escapeHTML(project.assignedContractor) : 'N/A'}
                            </div>
                            <!-- Last Update Time -->
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <strong>Last Update:</strong> <span class="${syncColor} font-semibold">${lastSync}</span>
                            </div>
                            <!-- NEW: Value Display -->
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 4.25A2.25 2.25 0 0113.25 12H17m-6 4v2a2 2 0 002 2h2a2 2 0 002-2v-2m-4-4H9a2 2 0 00-2 2v2m0-4V7a2 2 0 012-2h2a2 2 0 012 2v2"></path></svg>
                                <strong>Value:</strong> ${formatAsPHP(completedValue)} / ${formatAsPHP(totalProjectCost)}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <strong>Start:</strong> ${startDate}
                            </div>
                            <div class="flex items-center gap-2 col-span-2">
                                 <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <strong>Location:</strong> ${project.location ? escapeHTML(project.location) : 'N/A'}
                            </div>
                        </div>
                        ${project.description ? `<p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border border-gray-200">${escapeHTML(project.description)}</p>` : ''}
                    </div>
                    
                    <!-- New Project-Level Task Toggle -->
                    <div class="flex justify-between items-center mb-3 border-t border-gray-200 pt-4">
                        <h5 class="text-lg font-semibold text-gray-700">Tasks</h5>
                        <div class="flex items-center gap-3">
                            <button type="button" class="project-task-toggle text-sm font-medium text-indigo-600 hover:text-indigo-700" data-project-id="${project.id}" data-collapsed="false">
                                Collapse Tasks
                            </button>
                            <button type="button" class="open-add-task-modal-btn rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-indigo-700 transition-colors duration-150 form-button" data-project-id="${project.id}">
                                Add Task
                            </button>
                        </div>
                    </div>
                    
                    <div id="tasks-wrapper-${project.id}" class="space-y-4 mb-5 flex-1">
                        ${renderTaskGroups(taskGroups, project.id)}
                    </div>
                `;
                adminProjectsList.appendChild(projectEl);
            });

            // --- Add Event Listeners for Edit Buttons ---
            adminProjectsList.querySelectorAll('.open-edit-project-modal-btn').forEach(btn => {
                btn.addEventListener('click', handleOpenEditProjectModal);
            });
            
            adminProjectsList.querySelectorAll('.open-edit-task-modal-btn').forEach(btn => {
                btn.addEventListener('click', handleOpenEditTaskModal);
            });
            
            // --- NEW: Add Event Listeners for Delete Buttons ---
            adminProjectsList.querySelectorAll('.open-delete-modal-btn').forEach(btn => {
                btn.addEventListener('click', handleOpenDeleteModal);
            });
            
            // --- Add Event Listeners for existing buttons ---
            adminProjectsList.querySelectorAll('.open-add-task-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const projectId = e.currentTarget.dataset.projectId;
                    addTaskProjectIdInput.value = projectId;
                    openModal(addTaskModal);
                });
            });
            
            adminProjectsList.querySelectorAll('.toggle-task-group-btn').forEach(button => {
                button.addEventListener('click', handleToggleCollapsible);
            });
            
            adminProjectsList.querySelectorAll('.project-task-toggle').forEach(button => {
                button.addEventListener('click', handleProjectToggleTasks);
            });
        }
        
        function renderContractorProjectCards() {
            contractorProjectCardsList.innerHTML = '';
            
            if (allProjectsCache.length === 0) {
                contractorProjectCardsList.innerHTML = '<p class="text-gray-500 p-6 text-center bg-white rounded-xl shadow-lg border border-gray-200">You have no projects assigned to you.</p>';
                contractorProjectCardsList.className = 'space-y-6';
                return;
            }
            
            contractorProjectCardsList.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';

            const sortedProjects = [...allProjectsCache].sort((a, b) => (new Date(b.createdAt) || 0) - (new Date(a.createdAt) || 0));

            sortedProjects.forEach(project => {
                const projectTasks = project.tasks || [];
                const sortedTasks = [...projectTasks].sort((a, b) => (new Date(a.createdAt) || 0) - (new Date(b.createdAt) || 0));
                
                const taskGroups = groupTasks(sortedTasks);
                const projectEl = document.createElement('div');
                projectEl.className = 'border border-gray-200 rounded-lg p-5 shadow-sm bg-white flex flex-col';
                
                // UPDATED: Progress calculation
                const { progress, completedValue, totalProjectCost } = calculateProjectProgress(projectTasks);
                const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString() : 'N/A';
                const endDate = project.targetEndDate ? new Date(project.targetEndDate).toLocaleDateString() : 'N/A';

                projectEl.innerHTML = `
                    <div class="mb-4">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-3 gap-2">
                            <h4 class="text-2xl font-semibold text-gray-800">${escapeHTML(project.name)}</h4>
                            <span class="text-sm font-semibold text-indigo-600 flex-shrink-0">${progress.toFixed(0)}% Complete</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-4">
                            <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700 border-t border-b border-gray-100 py-3 mb-3">
                             <!-- NEW: Value Display -->
                            <div class="flex items-center gap-2 col-span-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 4.25A2.25 2.25 0 0113.25 12H17m-6 4v2a2 2 0 002 2h2a2 2 0 002-2v-2m-4-4H9a2 2 0 00-2 2v2m0-4V7a2 2 0 012-2h2a2 2 0 012 2v2"></path></svg>
                                <strong>Value:</strong> ${formatAsPHP(completedValue)} / ${formatAsPHP(totalProjectCost)}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <strong>Start:</strong> ${startDate}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <strong>Target:</strong> ${endDate}
                            </div>
                            <div class="flex items-center gap-2 col-span-2">
                                 <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <strong>Location:</strong> ${project.location ? escapeHTML(project.location) : 'N/A'}
                            </div>
                        </div>
                        ${project.description ? `<p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border border-gray-200">${escapeHTML(project.description)}</p>` : ''}
                    </div>
                    
                    <!-- New Project-Level Task Toggle -->
                    <div class="flex justify-between items-center mb-3 border-t border-gray-200 pt-4">
                        <h5 class="text-lg font-semibold text-gray-700">Tasks</h5>
                        <button type="button" class="project-task-toggle text-sm font-medium text-indigo-600 hover:text-indigo-700" data-project-id="${project.id}" data-collapsed="false">
                            Collapse Tasks
                        </button>
                    </div>

                    <div id="tasks-wrapper-${project.id}" class="space-y-4 mb-5 flex-1">
                        ${renderTaskGroups(taskGroups, project.id)}
                    </div>
                `;
                contractorProjectCardsList.appendChild(projectEl);
            });
            
            contractorProjectCardsList.querySelectorAll('.toggle-task-group-btn').forEach(button => {
                button.addEventListener('click', handleToggleCollapsible);
            });
            
            contractorProjectCardsList.querySelectorAll('.task-status-select').forEach(select => {
                select.addEventListener('change', handleUpdateTaskStatus);
            });
            
            contractorProjectCardsList.querySelectorAll('.task-qty-input').forEach(input => {
                input.addEventListener('change', handleUpdateTaskQty);
            });
            
            contractorProjectCardsList.querySelectorAll('.project-task-toggle').forEach(button => {
                button.addEventListener('click', handleProjectToggleTasks);
            });
        }

        // --- NEW: Project-Specific Collapse/Expand Logic ---

        // Function to toggle all task groups within a single project
        function handleProjectToggleTasks(e) {
            const button = e.currentTarget;
            const projectId = button.dataset.projectId;
            // 'data-collapsed' is the state of the content BEFORE the click.
            const isCurrentlyCollapsed = button.dataset.collapsed === 'true'; 
            
            const wrapper = document.getElementById(`tasks-wrapper-${projectId}`);
            if (!wrapper) return;

            const groupButtons = wrapper.querySelectorAll('.toggle-task-group-btn');
            
            // Determine if we should SHOW (expand) or HIDE (collapse)
            const shouldShow = isCurrentlyCollapsed; 
            
            groupButtons.forEach(groupBtn => {
                const targetId = groupBtn.dataset.target;
                const targetElement = document.getElementById(targetId);
                if (!targetElement) return;

                targetElement.classList.toggle('hidden', !shouldShow);
                groupBtn.setAttribute('aria-expanded', shouldShow);
                
                const openIcon = groupBtn.querySelector('.toggle-icon-open');
                const closedIcon = groupBtn.querySelector('.toggle-icon-closed');
                
                if (openIcon) openIcon.classList.toggle('hidden', !shouldShow);
                if (closedIcon) closedIcon.classList.toggle('hidden', shouldShow);
            });

            // Update the project-level button state and text
            button.dataset.collapsed = !isCurrentlyCollapsed;
            button.textContent = isCurrentlyCollapsed ? 'Collapse Tasks' : 'Expand Tasks';
        }
        
        // --- Cost-Weighted Progress Calculation ---
        function calculateProjectProgress(projectTasks) {
            if (!projectTasks || projectTasks.length === 0) {
                return { progress: 0, completedValue: 0, totalProjectCost: 0 };
            }

            let totalProjectCost = 0;
            let completedValue = 0;

            projectTasks.forEach(t => {
                const cost = parseFloat(t.cost) || 0;
                const totalQty = parseFloat(t.totalQty) || 0;
                const qtyCompleted = parseFloat(t.qtyCompleted) || 0;
                
                totalProjectCost += cost;

                if (cost > 0) {
                    if (totalQty > 0) {
                        // Qty-based task: progress is (qtyCompleted / totalQty)
                        const costPerUnit = cost / totalQty;
                        completedValue += costPerUnit * qtyCompleted;
                    } else {
                        // Status-based task: progress is 100% if "Completed", 0% otherwise
                        if (t.status === 'Completed') {
                            completedValue += cost;
                        }
                    }
                }
            });

            // Fallback to old unweighted method if total cost is 0
            if (totalProjectCost === 0) {
                const progressValues = projectTasks.map(t => {
                    const totalQty = parseFloat(t.totalQty) || 0;
                    const qtyCompleted = parseFloat(t.qtyCompleted) || 0;
                    
                    if (totalQty > 0) {
                        return (qtyCompleted / totalQty) * 1 || 0;
                    } else {
                        return t.status === 'Completed' ? 1 : 0;
                    }
                });
                
                const totalProgress = progressValues.reduce((sum, val) => sum + val, 0);
                const progress = (totalProgress / projectTasks.length) * 100 || 0;
                return { progress, completedValue: 0, totalProjectCost: 0 };
            }
            
            const progress = (completedValue / totalProjectCost) * 100 || 0;

            return { progress, completedValue, totalProjectCost };
        }
        
        function groupTasks(tasks) {
            const defaultGroup = 'General Tasks';
            return tasks.reduce((groups, task) => {
                const groupName = task.group || defaultGroup;
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(task);
                return groups;
            }, {});
        }
        
        function renderTaskGroups(taskGroups, projectId) {
            const groupNames = Object.keys(taskGroups).sort();
            
            if (groupNames.length === 0) {
                return '<p class="text-sm text-gray-500 italic px-3">No tasks yet.</p>';
            }

            return groupNames.map((groupName, index) => {
                const tasks = taskGroups[groupName];
                // Admin has smaller groups closed by default, contractor has all open
                let isInitiallyOpen = (currentRole === 'admin' && tasks.length <= 5) || (currentRole === 'contractor');
                
                const groupId = `task-group-${projectId}-${index}`;

                return `
                <div class="task-group border-t border-gray-100 pt-3 mt-3 first:mt-0 first:pt-0 first:border-t-0">
                    <div class="flex justify-between items-center mb-2 cursor-pointer toggle-task-group-btn" data-target="${groupId}" aria-expanded="${isInitiallyOpen}">
                        <h6 class="text-sm font-semibold text-gray-500 uppercase tracking-wide px-1">${escapeHTML(groupName)} (${tasks.length})</h6>
                        <button type="button" 
                                class="rounded-full p-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-900" 
                                aria-label="Toggle task group">
                            <svg class="w-5 h-5 toggle-icon-open ${isInitiallyOpen ? '' : 'hidden'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                            <svg class="w-5 h-5 toggle-icon-closed ${isInitiallyOpen ? 'hidden' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="${groupId}" class="space-y-3 pl-2 transition-all duration-300 ${isInitiallyOpen ? '' : 'hidden'}">
                        ${tasks.map(task => currentRole === 'admin' ? renderAdminTask(task) : renderContractorTask(task)).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderAdminTask(task) {
            const totalQty = parseFloat(task.totalQty) || 0;
            const hasQty = totalQty > 0;
            const qtyCompleted = parseFloat(task.qtyCompleted) || 0;
            const unit = task.unit ? ` ${escapeHTML(task.unit)}` : '';
            const cost = parseFloat(task.cost) || 0;
            
            // --- NEW: Change Tracking Logic ---
            const lastStatus = task._lastStatus || '';
            const lastQty = parseFloat(task._lastQty) || 0;
            const hasUnsyncedQty = hasQty && (lastQty !== qtyCompleted);
            const hasUnsyncedStatus = !hasQty && (lastStatus && lastStatus !== task.status);
            
            let statusOrQty;
            
            if (hasQty) {
                statusOrQty = `
                    <span class="text-sm font-bold text-indigo-700 flex items-center">
                        ${hasUnsyncedQty ? `<span class="text-red-500 line-through mr-1">${lastQty}${unit}</span>` : ''}
                        ${qtyCompleted} / ${totalQty}${unit}
                    </span>`;
            } else {
                statusOrQty = `
                    <span class="text-xs sm:text-sm font-bold uppercase px-3 py-1 rounded-full flex items-center
                        ${task.status === 'Completed' ? 'bg-green-100 text-green-800' :
                        (task.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-700')}
                    ">
                        ${hasUnsyncedStatus ? `<span class="text-red-500 line-through mr-1">${escapeHTML(lastStatus)}</span>` : ''}
                        ${escapeHTML(task.status)}
                    </span>`;
            }
            
            return `
                <div class="flex justify-between items-center p-3 rounded-md ${task.status === 'Completed' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'} border">
                    <div>
                        <span class="text-gray-800 font-medium">${escapeHTML(task.name)}</span>
                        <span class="block text-sm text-gray-500">${formatAsPHP(cost)}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        ${statusOrQty}
                        <button type="button" class="open-edit-task-modal-btn rounded-md p-1 text-gray-500 hover:bg-gray-100 hover:text-gray-800" data-task-id="${task.id}" data-project-id="${task.projectId}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                        </button>
                        <!-- NEW: Delete Task Button -->
                        <button type="button" class="open-delete-modal-btn rounded-md p-1 text-red-600 hover:bg-red-100 hover:text-red-800" data-item-type="task" data-task-id="${task.id}" data-project-id="${task.projectId}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderContractorTask(task) {
            const selectId = `status-select-${task.id}`;
            const qtyInputId = `qty-input-${task.id}`;
            const totalQty = parseFloat(task.totalQty) || 0;
            const hasQty = totalQty > 0;
            const qtyCompleted = parseFloat(task.qtyCompleted) || 0;
            const unit = task.unit ? ` ${escapeHTML(task.unit)}` : '';
            const cost = parseFloat(task.cost) || 0;
            
            let controlsHTML = '';

            if (hasQty) {
                controlsHTML = `
                <div class="flex items-center gap-1.5 w-full sm:w-auto">
                    <label for="${qtyInputId}" class="text-sm text-gray-600 font-medium">Qty:</label>
                    <div class="flex">
                        <input type="number" 
                               id="${qtyInputId}" 
                               data-task-id="${task.id}" 
                               data-total-qty="${totalQty}"
                               class="task-qty-input form-number-input form-input block w-24 rounded-lg border-gray-300 shadow-sm py-1.5 px-3 text-sm focus:border-indigo-500 focus:ring-indigo-500" 
                               value="${qtyCompleted}" 
                               min="0" 
                               max="${totalQty}">
                        <span class="text-gray-600 ml-2 self-center font-medium">/ ${totalQty}${unit}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <span class="text-sm text-gray-600 font-medium">Status:</span>
                    <span class="text-xs sm:text-sm font-bold uppercase px-3 py-1 rounded-full
                        ${task.status === 'Completed' ? 'bg-green-100 text-green-800' :
                        (task.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-700')}
                    ">
                        ${escapeHTML(task.status)}
                    </span>
                </div>
                `;
            } else {
                controlsHTML = `
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="${selectId}" class="text-sm text-gray-600 font-medium">Status:</label>
                    <select id="${selectId}" data-task-id="${task.id}" class="task-status-select form-select block w-full sm:w-auto rounded-lg border-gray-300 shadow-sm py-1.5 pl-3 pr-8 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                        ${TASK_STATUSES.map(status => `
                            <option value="${status}" ${task.status === status ? 'selected' : ''}>
                                ${status}
                            </option>
                        `).join('')}
                    </select>
                </div>
                `;
            }

            return `
                <div class="p-3 rounded-lg bg-white border border-gray-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <div>
                            <span class="text-base text-gray-800 font-medium">${escapeHTML(task.name)}</span>
                            <span class="block text-sm text-gray-500">${formatAsPHP(cost)}</span>
                        </div>
                        ${!hasQty ? `<span class="sm:hidden text-xs font-bold uppercase px-2 py-0.5 rounded-full ${
                            task.status === 'Completed' ? 'bg-green-100 text-green-800' :
                            (task.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-700')
                        }">${escapeHTML(task.status)}</span>` : ''}
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3">
                        ${controlsHTML}
                    </div>
                </div>
            `;
        }

        // --- EVENT HANDLERS ---

        async function handleAddProject(e) {
            e.preventDefault();
            
            const projectName = newProjectNameInput.value.trim();
            if (!projectName) {
                showToast("Project Name is required.", 'error');
                return;
            }
            
            const newProject = {
                id: crypto.randomUUID(),
                name: projectName,
                startDate: newProjectStartDateInput.value || null,
                targetEndDate: newProjectEndDateInput.value || null,
                location: newProjectLocationInput.value.trim() || null,
                assignedContractor: newProjectContractorInput.value.trim() || null,
                description: newProjectDescriptionInput.value.trim() || null,
                createdAt: new Date().toISOString(),
                tasks: [],
                // NEW: Initialize sync timestamp
                lastContractorSync: null 
            };
            
            allProjectsCache.push(newProject);
            saveDataToLocal();
            renderAdminProjects();
            
            closeModal(addProjectModal);
            showToast("Project added locally. Press 'Update Database' to sync.");
            setUnsyncedChanges(true); // USE SETTER
        }

        function handleOpenEditProjectModal(e) {
            const projectId = e.currentTarget.dataset.projectId;
            const project = allProjectsCache.find(p => p.id === projectId);
            
            if (!project) {
                showToast("Error: Project not found.", 'error');
                return;
            }
            
            editProjectIdInput.value = project.id;
            editProjectNameInput.value = project.name;
            editProjectStartDateInput.value = project.startDate || '';
            editProjectEndDateInput.value = project.targetEndDate || '';
            editProjectLocationInput.value = project.location || '';
            editProjectContractorInput.value = project.assignedContractor || '';
            editProjectDescriptionInput.value = project.description || '';
            
            openModal(editProjectModal);
        }

        async function handleEditProject(e) {
            e.preventDefault();
            
            const projectId = editProjectIdInput.value;
            const projectName = editProjectNameInput.value.trim();
            
            if (!projectId) {
                showToast("Error: Project ID is missing.", 'error');
                return;
            }
            if (!projectName) {
                showToast("Project Name is required.", 'error');
                return;
            }
            
            const projectIndex = allProjectsCache.findIndex(p => p.id === projectId);
            if (projectIndex === -1) {
                showToast("Error: Project not found in cache.", 'error');
                return;
            }
            
            allProjectsCache[projectIndex] = {
                ...allProjectsCache[projectIndex], 
                name: projectName,
                startDate: editProjectStartDateInput.value || null,
                targetEndDate: editProjectEndDateInput.value || null,
                location: editProjectLocationInput.value.trim() || null,
                assignedContractor: editProjectContractorInput.value.trim() || null,
                description: editProjectDescriptionInput.value.trim() || null,
            };
            
            saveDataToLocal();
            renderAdminProjects();
            
            closeModal(editProjectModal);
            showToast("Project updated locally. Press 'Update Database' to sync.");
            setUnsyncedChanges(true); // USE SETTER
        }

        async function handleAddTask(e) {
            e.preventDefault();
            
            const taskName = newTaskNameInput.value.trim();
            const projectId = addTaskProjectIdInput.value;
            let taskCost = parseFloat(newTaskCostInput.value) || 1; // Default to 1
            if (taskCost <= 0) {
                taskCost = 1; // Ensure it's 1 if user enters 0 or negative
            }
            
            if (!taskName || !projectId) {
                showToast("Task Name is required.", 'error');
                return;
            }
            
            const project = allProjectsCache.find(p => p.id === projectId);
            if (!project) {
                showToast("Error: Project not found.", 'error');
                return;
            }

            const newTask = {
                id: crypto.randomUUID(),
                name: taskName,
                group: newTaskGroupInput.value.trim() || null,
                projectId: projectId,
                status: "Not Started",
                cost: taskCost, // Use the sanitized/defaulted cost
                totalQty: parseFloat(newTaskTotalQtyInput.value) || 0,
                qtyCompleted: 0,
                unit: newTaskUnitInput.value.trim() || null,
                createdAt: new Date().toISOString()
            };
            
            if (!project.tasks) project.tasks = [];
            project.tasks.push(newTask);
            
            saveDataToLocal();
            renderAdminProjects();

            closeModal(addTaskModal);
            showToast("Task added locally. Press 'Update Database' to sync.");
            setUnsyncedChanges(true); // USE SETTER
        }

        function handleOpenEditTaskModal(e) {
            const taskId = e.currentTarget.dataset.taskId;
            const projectId = e.currentTarget.dataset.projectId;
            
            const project = allProjectsCache.find(p => p.id === projectId);
            if (!project || !project.tasks) {
                showToast("Error: Project not found.", 'error');
                return;
            }
            
            const task = project.tasks.find(t => t.id === taskId);
            if (!task) {
                showToast("Error: Task not found.", 'error');
                return;
            }
            
            editTaskIdInput.value = task.id;
            editTaskProjectIdInput.value = task.projectId;
            editTaskNameInput.value = task.name;
            editTaskGroupInput.value = task.group || '';
            editTaskCostInput.value = task.cost || 1; // Default to 1 if missing
            editTaskTotalQtyInput.value = task.totalQty || '';
            editTaskUnitInput.value = task.unit || '';
            editTaskQtyCompletedInput.value = task.qtyCompleted || 0;
            
            // NEW: Dynamically populate and set status
            editTaskStatusInput.innerHTML = TASK_STATUSES.map(status => `<option value="${status}">${status}</option>`).join('');
            editTaskStatusInput.value = task.status;
            
            openModal(editTaskModal);
        }

        async function handleEditTask(e) {
            e.preventDefault();
            
            const taskId = editTaskIdInput.value;
            const projectId = editTaskProjectIdInput.value;
            const taskName = editTaskNameInput.value.trim();
            let taskCost = parseFloat(editTaskCostInput.value) || 1; // Default to 1
            if (taskCost <= 0) {
                taskCost = 1; // Ensure it's 1 if user enters 0 or negative
            }
            
            if (!taskId || !projectId) {
                showToast("Error: Task or Project ID is missing.", 'error');
                return;
            }
            if (!taskName) {
                showToast("Task Name is required.", 'error');
                return;
            }
            
            const project = allProjectsCache.find(p => p.id === projectId);
            if (!project || !project.tasks) {
                showToast("Error: Project not found in cache.", 'error');
                return;
            }
            
            const taskIndex = project.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) {
                showToast("Error: Task not found in cache.", 'error');
                return;
            }
            
            const oldTask = project.tasks[taskIndex];
            const newTotalQty = parseFloat(editTaskTotalQtyInput.value) || 0;
            let newQtyCompleted = parseFloat(editTaskQtyCompletedInput.value) || 0;

            // Validate Qty Completed
            if (newTotalQty > 0 && newQtyCompleted > newTotalQty) {
                newQtyCompleted = newTotalQty; // Cap at max
            } else if (newTotalQty <= 0) {
                newQtyCompleted = 0; // Reset if it's not a qty-based task
            }

            // Auto-update status based on qty
            let newStatus = editTaskStatusInput.value;
            if (newTotalQty > 0) {
                if (newQtyCompleted <= 0) newStatus = "Not Started";
                else if (newQtyCompleted >= newTotalQty) newStatus = "Completed";
                else newStatus = "In Progress";
            }
            
            project.tasks[taskIndex] = {
                ...oldTask,
                name: taskName,
                group: editTaskGroupInput.value.trim() || null,
                cost: taskCost, // Use the sanitized/defaulted cost
                totalQty: newTotalQty,
                unit: editTaskUnitInput.value.trim() || null,
                qtyCompleted: newQtyCompleted,
                status: newStatus,
            };
            
            saveDataToLocal();
            renderAdminProjects();
            
            closeModal(editTaskModal);
            showToast("Task updated locally. Press 'Update Database' to sync.");
            setUnsyncedChanges(true); // USE SETTER
        }
        
        function handleToggleCollapsible(e) {
            const button = e.currentTarget;
            const targetId = button.dataset.target;
            const targetElement = document.getElementById(targetId);
            
            if (!targetElement) return;

            const isExpanding = targetElement.classList.toggle('hidden');
            const isCurrentlyOpen = !isExpanding;
            
            const openIcon = button.querySelector('.toggle-icon-open');
            const closedIcon = button.querySelector('.toggle-icon-closed');
            
            if (openIcon) openIcon.classList.toggle('hidden', !isCurrentlyOpen);
            if (closedIcon) closedIcon.classList.toggle('hidden', isCurrentlyOpen);
            
            button.setAttribute('aria-expanded', isCurrentlyOpen);
        }

        async function handleUpdateTaskStatus(e) {
            const select = e.target;
            const taskId = select.dataset.taskId;
            const newStatus = select.value;

            if (!taskId || !newStatus) return;
            
            let taskFound = false;
            for (const project of allProjectsCache) {
                const task = (project.tasks || []).find(t => t.id === taskId);
                if (task) {
                    const totalQty = parseFloat(task.totalQty) || 0;
                    if (totalQty > 0) {
                         // This shouldn't be called for qty-based tasks, but as a safeguard
                        console.warn("Status select used on qty-based task. Ignored.");
                        select.value = task.status; // Revert UI
                        return;
                    }
                    
                    // NEW: Store previous status if it changed
                    if (task.status !== newStatus) {
                        task._lastStatus = task.status;
                        task.status = newStatus;
                        setUnsyncedChanges(true); // USE SETTER
                    }

                    taskFound = true;
                    break;
                }
            }
            
            if (taskFound) {
                saveDataToLocal();
                renderContractorProjectCards();
            }
        }
        
        async function handleUpdateTaskQty(e) {
            const input = e.target;
            const taskId = input.dataset.taskId;
            const totalQty = parseFloat(input.dataset.totalQty);
            let newQty = parseFloat(input.value);

            if (!taskId) return;
            
            if (isNaN(newQty) || newQty < 0) newQty = 0;
            if (newQty > totalQty) newQty = totalQty;
            input.value = newQty; // Correct input if invalid
            
            let newStatus;
            if (newQty <= 0) {
                newStatus = "Not Started";
            } else if (newQty >= totalQty) {
                newStatus = "Completed";
            } else {
                newStatus = "In Progress";
            }
            
            let taskFound = false;
            for (const project of allProjectsCache) {
                const task = (project.tasks || []).find(t => t.id === taskId);
                if (task) {
                    // NEW: Store previous qty if it changed
                    if (task.qtyCompleted !== newQty) {
                         task._lastQty = task.qtyCompleted;
                         task.qtyCompleted = newQty;
                         setUnsyncedChanges(true); // USE SETTER
                    }
                    
                    task.status = newStatus;
                    taskFound = true;
                    break;
                }
            }
            
            if (taskFound) {
                saveDataToLocal();
                renderContractorProjectCards();
            }
        }
        
        // --- DELETE/CONFIRMATION LOGIC ---
        
        function handleOpenDeleteModal(e) {
            const btn = e.currentTarget;
            const itemType = btn.dataset.itemType;
            const projectId = btn.dataset.projectId;
            const taskId = btn.dataset.taskId;
            
            let message = '';
            
            confirmDeleteButton.dataset.itemType = itemType;
            confirmDeleteButton.dataset.projectId = projectId;
            
            // Set the modal to the delete state
            confirmDeleteButton.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmDeleteButton.classList.remove('bg-amber-600', 'hover:bg-amber-700');
            confirmDeleteButton.querySelector('.btn-text').textContent = 'Delete';
            
            if (itemType === 'project') {
                const project = allProjectsCache.find(p => p.id === projectId);
                message = `Are you sure you want to delete the project "<strong>${escapeHTML(project.name)}</strong>"? All associated tasks will also be deleted.`;
                confirmDeleteButton.dataset.taskId = ''; // Ensure it's clear
            } else if (itemType === 'task') {
                const project = allProjectsCache.find(p => p.id === projectId);
                const task = project.tasks.find(t => t.id === taskId);
                message = `Are you sure you want to delete the task "<strong>${escapeHTML(task.name)}</strong>"?`;
                confirmDeleteButton.dataset.taskId = taskId;
            }

            deleteConfirmMessage.innerHTML = message + "<br><br>This action cannot be undone.";
            openModal(deleteConfirmModal);
        }
        
        // Renamed from handleConfirmDelete to handleConfirmAction
        function handleConfirmAction(e) {
            const btn = e.currentTarget;
            const itemType = btn.dataset.itemType;
            const projectId = btn.dataset.projectId;
            const taskId = btn.dataset.taskId;

            closeModal(deleteConfirmModal); // Close the modal immediately

            // --- Handle LOGOUT action ---
            if (itemType === 'logout') {
                performLogout();
                return;
            }
            
            // --- Handle DELETE action ---
            if (itemType === 'project') {
                allProjectsCache = allProjectsCache.filter(p => p.id !== projectId);
                showToast("Project deleted locally. Press 'Update Database' to sync.");
            } else if (itemType === 'task') {
                const project = allProjectsCache.find(p => p.id === projectId);
                if (project) {
                    project.tasks = project.tasks.filter(t => t.id !== taskId);
                }
                showToast("Task deleted locally. Press 'Update Database' to sync.");
            }
            
            saveDataToLocal();
            
            if (currentRole === 'admin') {
                renderAdminProjects();
            } else if (currentRole === 'contractor') {
                renderContractorProjectCards();
            }

            setUnsyncedChanges(true); // USE SETTER
        }
        
        // --- DATA CLEANUP FOR SYNC ---
        function sanitizeProjectForSync(project) {
            // Create a deep clone to avoid modifying the original cache directly before the successful sync
            const cleanProject = JSON.parse(JSON.stringify(project)); 
            
            // Remove SheetDB's row ID, which is not part of the project data schema
            delete cleanProject._sheetdbId; 
            
            // Remove temporary tracking fields from tasks as the current state becomes the new baseline
            cleanProject.tasks = (cleanProject.tasks || []).map(task => {
                delete task._lastStatus;
                delete task._lastQty;
                return task;
            });

            return cleanProject;
        }


        // --- DATA FETCHING ---

        async function loadAdminDataFromSheetDB() {
            try {
                const res = await fetch(`${SHEETDB_API_URL}?sheet=${DATA_SHEET}`);

                if (!res.ok) {
                    let errorText = "Could not read error response.";
                    try {
                        errorText = await res.text();
                        const errorData = JSON.parse(errorText);
                        
                        if (errorData.error && errorData.error.includes("Sheet not found")) {
                            console.error(`CRITICAL ERROR: The Google Sheet tab named '${DATA_SHEET}' was not found. Please check your Google Sheet tabs.`);
                            throw new Error(`SheetDB Error: The sheet tab '${DATA_SHEET}' was not found.`);
                        }
                        console.error("Failed to fetch data:", errorData);
                        throw new Error(`Failed to fetch data: ${errorData.error || errorText}`);
                    } catch(e) { 
                        console.error("Failed to fetch data (non-JSON response):", errorText);
                        throw new Error(`Failed to fetch data: ${errorText}`);
                    }
                }

                const data = await res.json();
                
                const projects = data
                    .filter(row => row.Data && row.Data !== 'undefined')
                    .map(row => {
                        try {
                            // Attach SheetDB row details for syncing later
                            const project = JSON.parse(row.Data);
                            project._sheetdbId = row.id; 
                            // Ensure lastContractorSync exists for display
                            if (!project.lastContractorSync) project.lastContractorSync = null;
                            return project;
                        } catch (e) {
                            console.warn("Skipping invalid JSON data in row:", row, e);
                            return null;
                        }
                    })
                    .filter(p => p !== null); 
                
                return projects;
                
            } catch (error) {
                console.error("Error loading admin data: ", error);
                throw error;
            }
        }
        
        async function loadContractorDataFromSheetDB(username) {
            try {
                const res = await fetch(`${SHEETDB_API_URL}/search?Username=${encodeURIComponent(username)}&sheet=${DATA_SHEET}`);
                if (!res.ok) {
                    let errorText = "Could not read error response.";
                    try {
                        errorText = await res.text();
                        const errorData = JSON.parse(errorText);
                        
                        if (errorData.error && errorData.error.includes("Sheet not found")) {
                            console.error(`CRITICAL ERROR: The Google Sheet tab named '${DATA_SHEET}' was not found. Please check your Google Sheet tabs.`);
                            throw new Error(`SheetDB Error: The sheet tab '${DATA_SHEET}' was not found.`);
                        }
                        console.error("Failed to fetch projects:", errorData);
                        throw new Error(`Failed to fetch projects: ${errorData.error || errorText}`);
                    } catch(e) {
                        console.error("Failed to fetch projects (non-JSON response):", errorText);
                        throw new Error(`Failed to fetch projects: ${errorText}`);
                    }
                }
                
                const data = await res.json();
                
                const contractorProjects = data
                    .filter(row => row.Data && row.Data !== 'undefined')
                    .map(row => {
                        try {
                            // Attach SheetDB row details for syncing later
                            const project = JSON.parse(row.Data);
                            project._sheetdbId = row.id; 
                            // Ensure lastContractorSync exists for tracking
                            if (!project.lastContractorSync) project.lastContractorSync = null;
                            return project;
                        } catch (e) {
                            console.warn("Skipping invalid JSON data in row:", row, e);
                            return null;
                        }
                    })
                    .filter(p => p !== null); 
                
                return contractorProjects;

            } catch (error) {
                console.error("Error loading contractor data: ", error);
                throw error;
            }
        }
        
        // --- SYNC FUNCTIONS ---
        
        function showSyncLoading(isLoading, button = syncDataButton) {
            button.disabled = isLoading;
            button.querySelector('.btn-text').classList.toggle('hidden', isLoading);
            button.querySelector('.btn-spinner').classList.toggle('hidden', !isLoading);
        }
        
        async function handleSyncData() {
            if (SHEETDB_API_URL.includes('YOUR_API_ID')) {
                showToast("Please update the SHEETDB_API_URL in the script tag.", 'error');
                return;
            }
            
            showSyncLoading(true);
            
            if (currentRole === 'admin') {
                showToast("Syncing all data to database...");
                try {
                    await syncAdminData();
                    showToast("All data synced successfully!");
                    setUnsyncedChanges(false); // USE SETTER
                } catch (error) {
                    console.error("Sync failed:", error);
                    showToast(`Sync failed: ${error.message}`, 'error');
                } finally {
                    showSyncLoading(false);
                }
            } else if (currentRole === 'contractor') {
                showToast("Syncing your project data...");
                try {
                    await syncAllContractorProjects(); 
                    showToast("All your projects are synced!");
                    setUnsyncedChanges(false); // USE SETTER
                } catch (error) {
                    console.error("Sync failed for some projects:", error);
                    if (Array.isArray(error)) {
                        error.forEach(err => showToast(err.message, 'warning'));
                        showToast(`Sync completed with ${error.length} errors.`, 'warning');
                    } else {
                        showToast(`Sync failed: ${error.message}`, 'error');
                    }
                } finally {
                    showSyncLoading(false);
                }
            }
        }

        async function syncAdminData() {
            // The admin sync now wipes *all* data first, then re-uploads the entire local cache.
            const clearRes = await fetch(`${SHEETDB_API_URL}/all?sheet=${DATA_SHEET}`, {
                method: 'DELETE'
            });
            if (!clearRes.ok) throw new Error("Failed to clear data sheet.");

            if (allProjectsCache.length > 0) {
                const projectsToUpload = allProjectsCache
                    .filter(project => project && project.id) // Ensure project is valid
                    .map(project => {
                        // NEW: Sanitize the project by removing comparison fields before upload
                        const cleanProject = sanitizeProjectForSync(project);

                        return {
                            id: project.id,
                            Project: project.name,
                            Username: project.assignedContractor,
                            Data: JSON.stringify(cleanProject)
                        };
                    });
                
                if (projectsToUpload.length > 0) {
                    const uploadRes = await fetch(`${SHEETDB_API_URL}?sheet=${DATA_SHEET}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: projectsToUpload })
                    });
                    if (!uploadRes.ok) {
                        let errorText = "Could not read error response.";
                        try {
                            errorText = await uploadRes.text();
                            const errorData = JSON.parse(errorText);
                            console.error("SheetDB Project Upload Error:", errorData);
                            throw new Error(`Failed to upload projects. Server responded with: ${JSON.stringify(errorData)}`);
                        } catch (e) {
                            console.error("SheetDB Project Upload Error: Response was not JSON.", errorText);
                            throw new Error(`Failed to upload projects. Server responded with: ${errorText}`);
                        }
                    }
                }
            }
        }

        async function syncAllContractorProjects() {
            const currentSyncTime = new Date().toISOString();
            const projectsToSync = allProjectsCache.map(project => {
                // IMPORTANT: Update the local cache timestamp *before* syncing
                project.lastContractorSync = currentSyncTime; 
                return project;
            });
            
            if (projectsToSync.length === 0) {
                return; 
            }
            
            // Re-render the contractor view immediately to show the "Just now" sync time
            renderContractorProjectCards();
            saveDataToLocal();

            const promises = projectsToSync.map(project => syncSingleProject(project));
            
            const results = await Promise.allSettled(promises);

            const errorsToShow = [];
            const removedProjectIds = [];

            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    const project = projectsToSync[index];
                    const error = result.reason;

                    if (error.message.includes("Project not found in database")) {
                        removedProjectIds.push(project.id);
                    } else {
                        errorsToShow.push({ message: `Project '${escapeHTML(project.name)}': ${error.message}` });
                    }
                }
            });

            if (removedProjectIds.length > 0) {
                // If projects were deleted by admin, remove them from contractor's local view
                allProjectsCache = allProjectsCache.filter(p => !removedProjectIds.includes(p.id));
                saveDataToLocal();
                renderContractorProjectCards();
                showToast(`Removed ${removedProjectIds.length} project(s) that were deleted by admin.`, 'warning');
            }
            
            if (errorsToShow.length > 0) {
                throw errorsToShow;
            }
        }
        
        async function syncSingleProject(project) {
            if (!project || !project.id) {
                throw new Error("Invalid project data.");
            }
            
            // Check existence and get SheetDB ID
            let sheetdbId = project._sheetdbId;

            if (!sheetdbId) {
                 // Try to find the project by its content ID
                const res = await fetch(`${SHEETDB_API_URL}/search?id=${project.id}&sheet=${DATA_SHEET}`);
                if (!res.ok) {
                    throw new Error("Failed to check project existence during sync.");
                }

                const searchResult = await res.json();
                
                if (!Array.isArray(searchResult) || searchResult.length === 0) {
                    throw new Error("Project not found in database. It may have been deleted by an admin.");
                }
                
                sheetdbId = searchResult[0].id; // Get the sheetdb row ID
                project._sheetdbId = sheetdbId; // Update local cache with SheetDB ID
            }
            
            // If it exists, update it
            const projectToUpdate = {
                Data: JSON.stringify(project) // Only update the Data blob
            };

            const res = await fetch(`${SHEETDB_API_URL}/id/${sheetdbId}?sheet=${DATA_SHEET}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectToUpdate)
            });

            if (!res.ok) {
                let errorText = "Could not read error response.";
                try {
                    errorText = await res.text();
                    const errorData = JSON.parse(errorText);
                    console.error("SheetDB PATCH error:", errorData);
                    throw new Error(`Failed to update project. Server responded with: ${JSON.stringify(errorData)}`);
                } catch (e) {
                    console.error("SheetDB PATCH Error: Response was not JSON.", errorText);
                    throw new Error(`Failed to update project. Server responded with: ${errorText}`);
                }
            }
        }
        
        // NEW: Synchronous save function for browser exit (Contractors only)
        function syncOnClose() {
            // Only run for contractors with unsaved changes.
            if (currentRole !== 'contractor' || !hasUnsyncedChanges || SHEETDB_API_URL.includes('YOUR_API_ID')) {
                return;
            }
            
            const projectsToSync = allProjectsCache;
            const currentSyncTime = new Date().toISOString();

            for (const project of projectsToSync) {
                if (!project._sheetdbId) continue; 

                // 1. Update project and sanitize data for upload
                project.lastContractorSync = currentSyncTime;
                // Since this is synchronous, we create a clean, single object to send
                const cleanProject = sanitizeProjectForSync(project);
                
                const dataToSend = {
                    id: project._sheetdbId,
                    Data: JSON.stringify(cleanProject)
                };

                try {
                    const xhr = new XMLHttpRequest();
                    // Synchronous call (blocks, but guarantees transfer before browser closes)
                    xhr.open('PATCH', `${SHEETDB_API_URL}/id/${project._sheetdbId}?sheet=${DATA_SHEET}`, false); 
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    // SheetDB expects the object wrapped in { data: ... } for PATCH
                    xhr.send(JSON.stringify({ data: dataToSend })); 
                    
                    // Check status (200 is success for PATCH).
                    if (xhr.status !== 200) {
                         console.error(`Sync failed for project ${project.id} on close. Status: ${xhr.status}`);
                    }
                } catch (e) {
                    console.error("Synchronous sync failed:", e);
                }
            }
            // Reset state after attempting sync
            setUnsyncedChanges(false); // USE SETTER
        }


        
        // --- AUTHENTICATION & INITIALIZATION ---
        
        function performLogout() {
            // Core logout logic
            localStorage.removeItem(LOCAL_STORAGE_USER_KEY);
            currentRole = null;
            allProjectsCache = [];
            setUnsyncedChanges(false); // USE SETTER
            
            showView('login');
            // Clear dynamic content
            contractorProjectCardsList.innerHTML = '';
            adminProjectsList.innerHTML = '';
            // Reset button text
            syncDataButton.querySelector('.btn-text').textContent = 'Update Database';
            
            showToast("Logged out successfully.", 'success');
        }

        function handleLogout() {
            // Hide dropdown immediately
            userDropdown.classList.add('hidden');

            if (hasUnsyncedChanges) {
                if (currentRole === 'contractor') {
                    // Contractor immediately performs an async sync then logs out.
                    showToast("Unsaved work detected. Sending updates before logging out...", 'warning');
                    syncAllContractorProjects().finally(() => {
                        performLogout();
                    });
                    return; 
                } else if (currentRole === 'admin') {
                    // Admin gets the warning, as the full sync requires user explicit action.
                    deleteConfirmMessage.innerHTML = '<span class="text-amber-600 font-semibold">You have unsaved local changes.</span> Logging out will discard these changes. Are you sure you want to proceed?';
                    
                    // Use itemType to signal logout action to the confirmation handler
                    confirmDeleteButton.dataset.itemType = 'logout'; 
                    confirmDeleteButton.dataset.projectId = '';
                    confirmDeleteButton.dataset.taskId = '';
                    
                    // Change button appearance to reflect warning/logout
                    confirmDeleteButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    confirmDeleteButton.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    confirmDeleteButton.querySelector('.btn-text').textContent = 'Yes, Discard & Log Out';
                    
                    openModal(deleteConfirmModal);
                    return;
                }
            }
            performLogout();
        }
        
        async function initializeAppLogic() {
            if (SHEETDB_API_URL.includes('YOUR_API_ID') || SHEETDB_API_URL === '') {
                showView('login');
                loginView.innerHTML = `<p class="text-red-500 p-6 text-center text-lg font-medium">Application not configured. Please update the <code>SHEETDB_API_URL</code> variable in the &lt;script&gt; tag.</p>`;
                return;
            }

            const userStr = localStorage.getItem(LOCAL_STORAGE_USER_KEY);
            
            if (userStr) {
                const user = JSON.parse(userStr);
                currentRole = user.role;
                
                if (loadDataFromLocal()) {
                    if (currentRole === 'admin') {
                        // Admin loads from local initially
                        currentUserEl.textContent = `Logged in as Admin`;
                        syncDataButton.classList.remove('hidden'); 
                        updateSyncButtonState();
                        renderAdminProjects();
                        showView('admin');
                    } else if (currentRole === 'contractor' && user.username) {
                        // Contractor loads from local initially
                        currentUserEl.textContent = `Logged in as: ${escapeHTML(user.username)}`;
                        syncDataButton.classList.remove('hidden'); 
                        // IMPORTANT: Set to false on load unless the local cache explicitly marks it as true (not implemented yet)
                        setUnsyncedChanges(false); 
                        
                        updateSyncButtonState();
                        renderContractorProjectCards();
                        showToast("Data loaded from local cache. Click 'Update to Database' to sync updates.", 'warning');
                        showView('contractor');
                    } else {
                        // Invalid state, log out
                        handleLogout();
                    }
                } else {
                    // No local data, log out
                    handleLogout();
                }
            } else {
                showView('login');
            }
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }

        // --- INITIALIZE EVENT LISTENERS ---
        
        async function handleContractorLogin(e) {
            e.preventDefault();
            const username = contractorUsernameInput.value.trim();
            if (!username) {
                loginError.textContent = 'Please enter a username.';
                return;
            }

            // Check if user is already logged in with local data
            const localUserStr = localStorage.getItem(LOCAL_STORAGE_USER_KEY);
            let localUser = null;
            if (localUserStr) {
                localUser = JSON.parse(localUserStr);
            }

            if (localUser && localUser.role === 'contractor' && localUser.username === username && loadDataFromLocal()) {
                // User is re-logging in and local data exists, skip fetch, load local
                const user = { role: 'contractor', username: username };
                localStorage.setItem(LOCAL_STORAGE_USER_KEY, JSON.stringify(user));
                currentRole = 'contractor';
                
                currentUserEl.textContent = `Logged in as: ${escapeHTML(username)}`;
                syncDataButton.classList.remove('hidden'); 
                updateSyncButtonState();
                
                renderContractorProjectCards();
                showToast("Data loaded from local cache. Click 'Update to Database' to sync updates.", 'warning');
                showView('contractor');
                return; 
            }
            
            // If no local data or different user, proceed with fetch
            showFormLoading(contractorLoginForm, true);
            loginError.textContent = '';

            try {
                const projects = await loadContractorDataFromSheetDB(username);

                if (projects.length === 0) {
                    loginError.textContent = 'No projects are assigned to this username.';
                    console.warn("Login failed: No projects for user", username);
                } else {
                    allProjectsCache = projects;
                    
                    saveDataToLocal(); // Save fresh data to local
                    const user = { role: 'contractor', username: username };
                    localStorage.setItem(LOCAL_STORAGE_USER_KEY, JSON.stringify(user));
                    currentRole = 'contractor';
                    
                    currentUserEl.textContent = `Logged in as: ${escapeHTML(username)}`;
                    syncDataButton.classList.remove('hidden'); 
                    setUnsyncedChanges(false); // Fresh data means no unsynced changes
                    
                    renderContractorProjectCards();
                    showToast("Projects fetched and loaded from database.", 'success');
                    showView('contractor');
                }
            } catch (error) {
                console.error("Error during contractor login check: ", error);
                loginError.textContent = `Error: ${error.message}`;
            } finally {
                showFormLoading(contractorLoginForm, false);
            }
        }
        
        // --- DROPDOWN LOGIC ---
        function toggleDropdown(e) {
            e.stopPropagation(); // Prevent document click listener from firing immediately
            userDropdown.classList.toggle('hidden');
        }

        function closeDropdown() {
            userDropdown.classList.add('hidden');
        }
        
        dropdownToggle.addEventListener('click', toggleDropdown);
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!authControls.contains(e.target)) {
                closeDropdown();
            }
        });
        
        contractorLoginForm.addEventListener('submit', handleContractorLogin);

        adminLoginButton.addEventListener('click', () => {
            openModal(adminPinModal);
        });

        logoutButton.addEventListener('click', handleLogout); // Updated to use the new handler
        
        syncDataButton.addEventListener('click', handleSyncData);
        
        openAddProjectModalBtn.addEventListener('click', () => openModal(addProjectModal));
        
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                closeModal(modal);
            });
        });
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });
        
        // PIN Modal listeners
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', handlePinInput);
            input.addEventListener('keydown', handlePinBackspace);
            if (index === 0) {
                input.addEventListener('paste', handlePinPaste);
            }
        });
        
        // Form Submissions
        addProjectForm.addEventListener('submit', handleAddProject);
        addTaskForm.addEventListener('submit', handleAddTask);
        editProjectForm.addEventListener('submit', handleEditProject);
        editTaskForm.addEventListener('submit', handleEditTask); 
        confirmDeleteButton.addEventListener('click', handleConfirmAction); // Updated to use the new action handler
        
        // NEW: Attach the synchronous sync handler to beforeunload
        // This will run when the tab/window is closed, ensuring contractor data is saved.
        window.addEventListener('beforeunload', syncOnClose);

        // Start the application
        initializeAppLogic();

    </script>
</body>
</html>
